import { RecommendationUseCase } from '../domain/recommendationUseCase';
import { generateMockRecommendation } from '../domain/mockData';
import { loadConfig, missingCriticalKeys, type AppConfig } from '../common/config';
import { RecommendationRequest, type RecommendationResult, type PoiItem } from '../services/types';
import common from '@ohos.app.ability.common';
import promptAction from '@ohos.promptAction';

interface TravelFormData {
  departure: string;
  destination: string;
  travelDate: string;
  travelDays: string;
  companions: string;
  budget: string;
}

interface Interest {
  id: string;
  name: string;
  icon: string;
}

@Entry
@Component
struct TravelForm {
  @State departure: string = '';
  @State destination: string = '';
  @State travelDate: string = '';
  @State travelDays: string = '';
  @State companions: string = '2äºº (æƒ…ä¾£/æœ‹å‹)';
  @State budget: string = '';
  @State loading: boolean = false;
  @State result: RecommendationResult | null = null;
  @State error: string = '';
  @State config: AppConfig | null = null;
  @State configError: string = '';
  @State holidayExpanded: boolean = false;
  @State selectedInterests: string[] = [];
  @State generateBudget: boolean = false;
  @State generateMapLink: boolean = true;
  @State queryWeather: boolean = true;
  @State routePlanning: boolean = false;
  @State showCityPicker: boolean = false;
  @State showDeparturePicker: boolean = false;
  @State showCompanionPicker: boolean = false;
  @State citySearchText: string = '';
  @State departureSearchText: string = '';
  @State destinationSuggestions: string[] = [];
  @State departureSuggestions: string[] = [];
  @State showDestinationSuggestions: boolean = false;
  @State showDepartureSuggestions: boolean = false;

  private context?: common.UIAbilityContext;
  private useCase: RecommendationUseCase | null = null;

  // å…´è¶£åå¥½é€‰é¡¹
  private interests: Interest[] = [
    { id: 'food', name: 'ç¾é£Ÿ', icon: 'ğŸœ' },
    { id: 'nature', name: 'è‡ªç„¶é£å…‰', icon: 'â›°ï¸' },
    { id: 'citywalk', name: 'åŸå¸‚æ¼«æ­¥', icon: 'ğŸš¶' },
    { id: 'family', name: 'äº²å­', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' },
    { id: 'adventure', name: 'å°ä¼—å†’é™©', icon: 'ğŸ’' },
    { id: 'drive', name: 'è‡ªé©¾', icon: 'ğŸš—' },
    { id: 'hiking', name: 'å¾’æ­¥', icon: 'ğŸ¥¾' },
    { id: 'climbing', name: 'çˆ¬å±±', icon: 'â›°ï¸' },
    { id: 'shopping', name: 'å•†åœºé€›è¡—', icon: 'ğŸ›ï¸' },
  ];

  // èŠ‚å‡æ—¥é€‰é¡¹
  private holidays: string[] = [
    'æ˜¥èŠ‚', 'æ¸…æ˜èŠ‚', 'åŠ³åŠ¨èŠ‚', 'ç«¯åˆèŠ‚', 'ä¸­ç§‹èŠ‚', 'å›½åº†èŠ‚', 'å…ƒæ—¦'
  ];

  // åŒè¡Œäººæ•°é€‰é¡¹
  private companionOptions: string[] = [
    '1äºº (ç‹¬è‡ª)',
    '2äºº (æƒ…ä¾£/æœ‹å‹)',
    '3äºº',
    '4äºº',
    '5+äºº (å›¢é˜Ÿ)'
  ];

  // åŸå¸‚åˆ—è¡¨ï¼ˆæŒ‰å­—æ¯æ’åºï¼‰
  private cities: string[] = [
    'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'å—äº¬', 'æˆéƒ½', 'é‡åº†', 'æ­¦æ±‰', 'è¥¿å®‰',
    'å¤©æ´¥', 'è‹å·', 'é•¿æ²™', 'éƒ‘å·', 'ä¸œè', 'é’å²›', 'æ²ˆé˜³', 'å®æ³¢', 'æ˜†æ˜', 'å¤§è¿',
    'å¦é—¨', 'åˆè‚¥', 'ä½›å±±', 'ç¦å·', 'å“ˆå°”æ»¨', 'æµå—', 'æ¸©å·', 'çŸ³å®¶åº„', 'æ³‰å·', 'é•¿æ˜¥',
    'è´µé˜³', 'å¸¸å·', 'ç æµ·', 'é‡‘å', 'å˜‰å…´', 'å°å·', 'æƒ å·', 'ä¸­å±±', 'ä¿å®š', 'å…°å·',
    'æ½åŠ', 'ä¸´æ²‚', 'æ·„åš', 'æµå®', 'çƒŸå°', 'æ³°å®‰', 'èŠåŸ', 'å¨æµ·', 'æ£åº„', 'å¾·å·',
    'æ»¨å·', 'ä¸œè¥', 'èæ³½', 'æ—¥ç…§', 'è±èŠœ', 'é’å²›', 'æ½åŠ', 'ä¸´æ²‚', 'æ·„åš', 'æµå®',
    'ä¸‰äºš', 'æµ·å£', 'æ¡‚æ—', 'ä¸½æ±Ÿ', 'å¤§ç†', 'è¥¿åŒç‰ˆçº³', 'å¼ å®¶ç•Œ', 'ä¹å¯¨æ²Ÿ', 'é»„å±±', 'åºå±±',
    'å³¨çœ‰å±±', 'æ³°å±±', 'åå±±', 'è¡¡å±±', 'æ’å±±', 'åµ©å±±', 'äº”å°å±±', 'æ™®é™€å±±', 'æ­¦å½“å±±', 'é’åŸå±±',
    'æ‹‰è¨', 'ä¹Œé²æœ¨é½', 'å‘¼å’Œæµ©ç‰¹', 'é“¶å·', 'è¥¿å®', 'å…°å·', 'æ˜†æ˜', 'è´µé˜³', 'å—å®', 'æµ·å£',
    'é¦™æ¸¯', 'æ¾³é—¨', 'å°åŒ—', 'é«˜é›„', 'å°ä¸­', 'å°å—', 'æ–°åŒ—', 'æ¡ƒå›­', 'æ–°ç«¹', 'åŸºéš†'
  ].sort((a, b) => {
    // æŒ‰æ‹¼éŸ³é¦–å­—æ¯æ’åº
    return a.localeCompare(b, 'zh-CN');
  });

  // æŒ‰é¦–å­—æ¯åˆ†ç»„åŸå¸‚
  private getCitiesByLetter(): Map<string, string[]> {
    const grouped = new Map<string, string[]>();
    for (const city of this.cities) {
      // è·å–æ‹¼éŸ³é¦–å­—æ¯
      const firstLetter = this.getFirstLetter(city);
      if (!grouped.has(firstLetter)) {
        grouped.set(firstLetter, []);
      }
      grouped.get(firstLetter)?.push(city);
    }
    return grouped;
  }

  // è·å–ä¸­æ–‡æ‹¼éŸ³é¦–å­—æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
  private getFirstLetter(city: string): string {
    // ä½¿ç”¨localeCompareè·å–æ’åºé”®ï¼Œç„¶åå–é¦–å­—ç¬¦
    // ç®€åŒ–å®ç°ï¼šä½¿ç”¨UnicodeèŒƒå›´åˆ¤æ–­ï¼Œæˆ–ä½¿ç”¨é¦–å­—ç¬¦çš„æ‹¼éŸ³é¦–å­—æ¯æ˜ å°„
    const firstChar = city.charAt(0);
    
    // æ‰©å±•çš„æ‹¼éŸ³é¦–å­—æ¯æ˜ å°„
    const pinyinMap: Record<string, string> = {
      'åŒ—': 'B', 'ä¸Š': 'S', 'å¹¿': 'G', 'æ·±': 'S', 'æ­': 'H', 'å—': 'N', 'æˆ': 'C', 'é‡': 'C',
      'æ­¦': 'W', 'è¥¿': 'X', 'å¤©': 'T', 'è‹': 'S', 'é•¿': 'C', 'éƒ‘': 'Z', 'ä¸œ': 'D', 'é’': 'Q',
      'æ²ˆ': 'S', 'å®': 'N', 'æ˜†': 'K', 'å¤§': 'D', 'å¦': 'X', 'åˆ': 'H', 'ä½›': 'F', 'ç¦': 'F',
      'å“ˆ': 'H', 'æµ': 'J', 'æ¸©': 'W', 'çŸ³': 'S', 'æ³‰': 'Q', 'è´µ': 'G', 'å¸¸': 'C',
      'ç ': 'Z', 'é‡‘': 'J', 'å˜‰': 'J', 'å°': 'T', 'æƒ ': 'H', 'ä¸­': 'Z', 'ä¿': 'B', 'å…°': 'L',
      'ä¸‰': 'S', 'æµ·': 'H', 'æ¡‚': 'G', 'ä¸½': 'L', 'å¼ ': 'Z', 'ä¹': 'J', 'é»„': 'H', 'åº': 'L',
      'å³¨': 'E', 'å': 'H', 'è¡¡': 'H', 'æ’': 'H', 'åµ©': 'S', 'äº”': 'W', 'æ™®': 'P',
      'æ‹‰': 'L', 'ä¹Œ': 'W', 'å‘¼': 'H', 'é“¶': 'Y', 'é¦™': 'X', 'æ¾³': 'A', 'é«˜': 'G',
      'æ–°': 'X', 'åŸº': 'J', 'æ½': 'W', 'ä¸´': 'L', 'æ·„': 'Z', 'çƒŸ': 'Y', 'æ³°': 'T',
      'èŠ': 'L', 'å¨': 'W', 'æ£': 'Z', 'å¾·': 'D', 'æ»¨': 'B', 'è¥': 'Y', 'è': 'H',
      'æ—¥': 'R', 'è±': 'L', 'ç‰ˆ': 'B', 'å®¶': 'J', 'å±±': 'S', 'çœ‰': 'M', 'åŸ': 'C'
    };
    
    // å¦‚æœæ˜ å°„ä¸­æœ‰ï¼Œç›´æ¥è¿”å›
    if (pinyinMap[firstChar]) {
      return pinyinMap[firstChar];
    }
    
    // å¦‚æœæ˜¯è‹±æ–‡å­—æ¯ï¼Œç›´æ¥è¿”å›å¤§å†™
    if (/[A-Za-z]/.test(firstChar)) {
      return firstChar.toUpperCase();
    }
    
    // é»˜è®¤è¿”å›é¦–å­—ç¬¦ï¼ˆç”¨äºæœªçŸ¥å­—ç¬¦ï¼‰
    return firstChar;
  }

  // è·å–è¿‡æ»¤åçš„åŸå¸‚åˆ—è¡¨
  private getFilteredCities(): Map<string, string[]> {
    const grouped = this.getCitiesByLetter();
    if (!this.citySearchText.trim()) {
      return grouped;
    }
    const filtered = new Map<string, string[]>();
    const searchLower = this.citySearchText.toLowerCase();
    for (const entry of grouped.entries()) {
      const letter = entry[0];
      const cities = entry[1];
      const filteredCities = cities.filter(city => 
        city.includes(this.citySearchText) || 
        city.toLowerCase().includes(searchLower)
      );
      if (filteredCities.length > 0) {
        filtered.set(letter, filteredCities);
      }
    }
    return filtered;
  }

  // è·å–è¿‡æ»¤åçš„å‡ºå‘åœ°åŸå¸‚åˆ—è¡¨
  private getFilteredDepartureCities(): Map<string, string[]> {
    const grouped = this.getCitiesByLetter();
    if (!this.departureSearchText.trim()) {
      return grouped;
    }
    const filtered = new Map<string, string[]>();
    const searchLower = this.departureSearchText.toLowerCase();
    for (const entry of grouped.entries()) {
      const letter = entry[0];
      const cities = entry[1];
      const filteredCities = cities.filter(city => 
        city.includes(this.departureSearchText) || 
        city.toLowerCase().includes(searchLower)
      );
      if (filteredCities.length > 0) {
        filtered.set(letter, filteredCities);
      }
    }
    return filtered;
  }

  aboutToAppear() {
    this.context = getContext(this) as common.UIAbilityContext;
    this.loadConfiguration();
  }

  async loadConfiguration() {
    if (!this.context) {
      this.configError = 'æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡';
      return;
    }

    try {
      const configResult = await loadConfig(this.context);
      this.config = configResult.config;
      
      if (configResult.source === 'fallback') {
        this.configError = configResult.message || 'ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆMockæ¨¡å¼ï¼‰';
      }

      const missing = missingCriticalKeys(this.config);
      if (missing) {
        this.configError = missing;
      } else {
        this.useCase = new RecommendationUseCase(this.config);
      }
    } catch (error) {
      const err = error as Error;
      this.configError = `é…ç½®åŠ è½½å¤±è´¥: ${err.message}`;
    }
  }

  toggleInterest(interestId: string) {
    const index = this.selectedInterests.indexOf(interestId);
    if (index > -1) {
      this.selectedInterests.splice(index, 1);
    } else {
      this.selectedInterests.push(interestId);
    }
  }

  async handleGenerate() {
    if (!this.destination.trim()) {
      promptAction.showToast({
        message: 'è¯·å¡«å†™ç›®çš„åœ°',
        duration: 2000,
      });
      return;
    }

    this.loading = true;
    this.error = '';
    this.result = null;

    try {
      // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
      let query = `æˆ‘æƒ³å»${this.destination}`;
      if (this.travelDays) {
        query += `ç©${this.travelDays}å¤©`;
      }
      if (this.departure) {
        query += `ï¼Œä»${this.departure}å‡ºå‘`;
      }
      if (this.selectedInterests.length > 0) {
        const interestNames = this.selectedInterests.map(id => {
          const interest = this.interests.find(i => i.id === id);
          return interest?.name || id;
        });
        query += `ï¼Œå–œæ¬¢${interestNames.join('ã€')}`;
      }
      if (this.companions) {
        query += `ï¼Œ${this.companions}`;
      }
      if (this.budget) {
        query += `ï¼Œé¢„ç®—${this.budget}`;
      }

      let recommendation: RecommendationResult;

      if (this.config?.mockMode || !this.useCase) {
        recommendation = generateMockRecommendation(query);
      } else {
        const request: RecommendationRequest = {
          query: query,
          city: this.destination || this.config?.defaultCity,
          destination: this.destination,
          departure: this.departure,
          travelDate: this.travelDate,
        };
        recommendation = await this.useCase.getRecommendations(request);
      }

      this.result = recommendation;
    } catch (error) {
      const err = error as Error;
      this.error = err.message;
      promptAction.showToast({
        message: `ç”Ÿæˆå¤±è´¥: ${err.message}`,
        duration: 3000,
      });
    } finally {
      this.loading = false;
    }
  }

  build() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜
        Row() {
          Text('å¿«é€Ÿå¡«å†™æ—…è¡Œéœ€æ±‚')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1F1F1F')
          Text('âœ¨')
            .fontSize(18)
            .margin({ left: 4 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .padding({ left: 16, right: 16, top: 20, bottom: 16 })

        // èŠ‚å‡æ—¥å¿«æ·é€‰æ‹©å¡ç‰‡
        Column() {
          Row() {
            Column() {
              Row() {
                Text('âš¡')
                  .fontSize(16)
                Text('èŠ‚å‡æ—¥å¿«æ·é€‰æ‹©')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1F1F1F')
                  .margin({ left: 4 })
              }
              Text('å¿«é€Ÿè§„åˆ’å‡æœŸå‡ºæ¸¸')
                .fontSize(12)
                .fontColor('#666666')
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)

            Button(this.holidayExpanded ? 'æ”¶èµ·' : 'å±•å¼€')
              .type(ButtonType.Normal)
              .fontSize(12)
              .height(28)
              .backgroundColor('#F5F5F5')
              .fontColor('#333333')
              .onClick(() => {
                this.holidayExpanded = !this.holidayExpanded;
              })
          }
          .width('100%')

          if (this.holidayExpanded) {
            Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
              ForEach(this.holidays, (holiday: string) => {
                Button(holiday)
                  .type(ButtonType.Normal)
                  .fontSize(13)
                  .height(32)
                  .margin(4)
                  .backgroundColor('#FFFFFF')
                  .fontColor('#333333')
                  .border({
                    width: 1,
                    color: '#E0E0E0',
                    radius: 16
                  })
                  .onClick(() => {
                    // å¯ä»¥è®¾ç½®é»˜è®¤æ—¥æœŸç­‰
                    promptAction.showToast({
                      message: `å·²é€‰æ‹©${holiday}`,
                      duration: 1500,
                    });
                  })
              })
            }
            .width('100%')
            .margin({ top: 12 })
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
        .margin({ left: 16, right: 16, bottom: 16 })
        .shadow({
          radius: 4,
          color: '#1F000000',
          offsetX: 0,
          offsetY: 2,
        })

        // è¡¨å•è¾“å…¥åŒºåŸŸ
        Column() {
          // å‡ºå‘åœ°
          this.buildCityInputItem('ğŸ“', 'å‡ºå‘åœ°', 'é€‰æ‹©å‡ºå‘åŸå¸‚æˆ–è¾“å…¥è‡ªå®šä¹‰åœ°ç‚¹', this.departure, false, 'departure')

          // ç›®çš„åœ°ï¼ˆå¿…å¡«ï¼‰
          this.buildCityInputItem('âœˆï¸', 'ç›®çš„åœ°*', 'é€‰æ‹©ç›®çš„åœ°æˆ–è¾“å…¥è‡ªå®šä¹‰åœ°ç‚¹', this.destination, true, 'destination')

          // å‡ºè¡Œæ—¥æœŸ
          this.buildFormItem('ğŸ“…', 'å‡ºè¡Œæ—¥æœŸ', 'è¾“å…¥æ—¥æœŸï¼Œå¦‚ï¼š2025-12-15 è‡³ 2025-12-20', this.travelDate, (value: string) => {
            this.travelDate = value;
          })

          // æ—…è¡Œå¤©æ•°
          this.buildFormItem('ğŸ“…', 'æ—…è¡Œå¤©æ•°', 'é€‰æ‹©å¤©æ•°', this.travelDays, (value: string) => {
            this.travelDays = value;
          })

          // åŒè¡Œäººæ•°
          this.buildCompanionPickerItem('ğŸ‘¥', 'åŒè¡Œäººæ•°', this.companions)

          // é¢„ç®—èŒƒå›´
          this.buildFormItem('ğŸ’°', 'é¢„ç®—èŒƒå›´ (å¯é€‰)', 'å¦‚: 3000-5000å…ƒ', this.budget, (value: string) => {
            this.budget = value;
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
        .alignItems(HorizontalAlign.Start)

        // å…´è¶£åå¥½
        Column() {
          Text('å…´è¶£åå¥½')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1F1F1F')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 12 })

          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.interests, (interest: Interest) => {
              Button(`${interest.icon} ${interest.name}`)
                .type(ButtonType.Normal)
                .fontSize(13)
                .height(36)
                .margin(4)
                .backgroundColor(this.selectedInterests.includes(interest.id) ? '#007DFF' : '#FFFFFF')
                .fontColor(this.selectedInterests.includes(interest.id) ? '#FFFFFF' : '#333333')
                .border({
                  width: 1,
                  color: this.selectedInterests.includes(interest.id) ? '#007DFF' : '#E0E0E0',
                  radius: 18
                })
                .onClick(() => {
                  this.toggleInterest(interest.id);
                })
            })
          }
          .width('100%')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 24, bottom: 16 })
        .alignItems(HorizontalAlign.Start)

        // å¯é€‰åŠŸèƒ½
        Column() {
          Text('å¯é€‰åŠŸèƒ½')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1F1F1F')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 12 })

          this.buildCheckbox('ğŸ’°', 'ç”Ÿæˆé¢„ç®—æ˜ç»†', this.generateBudget, (value: boolean) => {
            this.generateBudget = value;
          })
          this.buildCheckbox('ğŸ—ºï¸', 'ç”Ÿæˆåœ°å›¾é“¾æ¥', this.generateMapLink, (value: boolean) => {
            this.generateMapLink = value;
          })
          this.buildCheckbox('â˜€ï¸', 'æŸ¥è¯¢å¤©æ°”ä¿¡æ¯', this.queryWeather, (value: boolean) => {
            this.queryWeather = value;
          })
          this.buildCheckbox('ğŸš—', 'è·¯çº¿è§„åˆ’æ¨è', this.routePlanning, (value: boolean) => {
            this.routePlanning = value;
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        .alignItems(HorizontalAlign.Start)

        // æç¤ºæ–‡å­—
        Text('å¡«å†™ç›®çš„åœ°åç‚¹å‡»ç”Ÿæˆ')
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 8, bottom: 16 })

        // ç”ŸæˆæŒ‰é’®
        Button() {
          Row() {
            Text('âœ¨')
              .fontSize(16)
            Text('å…è´¹ç”Ÿæˆè¡Œç¨‹')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .margin({ left: 4 })
          }
        }
        .type(ButtonType.Capsule)
        .width('90%')
        .height(48)
        .backgroundColor('#007DFF')
        .enabled(!this.loading && !!this.destination.trim())
        .onClick(() => {
          this.handleGenerate();
        })
        .margin({ bottom: 20 })

        // åŠ è½½çŠ¶æ€
        if (this.loading) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#007DFF')
            Text('æ­£åœ¨ç”Ÿæˆè¡Œç¨‹...')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
          }
          .width('100%')
          .padding({ top: 20, bottom: 20 })
        }

        // ç»“æœå±•ç¤º
        if (this.result && !this.loading) {
          Column() {
            Text('ğŸ’¡ æ™ºèƒ½æ¨è')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            this.buildFormattedText(this.result.summary)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .margin({ left: 16, right: 16, top: 16, bottom: 20 })

          // POIåˆ—è¡¨å±•ç¤º
          if (this.result.items && this.result.items.length > 0) {
            Column() {
              Text('ğŸ“ æ¨èåœ°ç‚¹')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 12 })

              ForEach(this.result.items, (item: PoiItem, index: number) => {
                this.buildPoiItem(item, index)
              })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .margin({ left: 16, right: 16, bottom: 20 })
            .alignItems(HorizontalAlign.Start)
          }
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
    .bindSheet(this.showCompanionPicker, this.buildCompanionPickerDialog(), {
      height: '50%',
      dragBar: true,
      showClose: false,
    })
  }


  @Builder
  buildFormItem(icon: string, label: string, placeholder: string, value: string, onChange: (value: string) => void, required?: boolean) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(16)
        Text(label)
          .fontSize(14)
          .fontColor('#333333')
          .margin({ left: 8 })
        if (required) {
          Text('*')
            .fontSize(14)
            .fontColor('#FF6B6B')
            .margin({ left: 2 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 8 })

      TextInput({ placeholder: placeholder })
        .width('100%')
        .height(44)
        .fontSize(14)
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
        .border({
          width: 1,
          color: '#E0E0E0',
        })
        .onChange((text: string) => {
          onChange(text);
        })
    }
    .width('100%')
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildCheckbox(icon: string, label: string, checked: boolean, onChange: (value: boolean) => void) {
    Row() {
      Checkbox()
        .select(checked)
        .selectedColor('#007DFF')
        .onChange((isChecked: boolean) => {
          onChange(isChecked);
        })
      Text(`${icon} ${label}`)
        .fontSize(14)
        .fontColor('#333333')
        .margin({ left: 8 })
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
    .margin({ bottom: 12 })
  }


  @Builder
  buildCityPickerItem(icon: string, label: string, placeholder: string, value: string, required?: boolean) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(16)
        Text(label)
          .fontSize(14)
          .fontColor('#333333')
          .margin({ left: 8 })
        if (required) {
          Text('*')
            .fontSize(14)
            .fontColor('#FF6B6B')
            .margin({ left: 2 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 8 })

      Row() {
        TextInput({ placeholder: placeholder, text: value })
          .layoutWeight(1)
          .height(44)
          .fontSize(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .border({
            width: 1,
            color: '#E0E0E0',
          })
          .enabled(false)
          .onClick(() => {
            if (required) {
              this.showCityPicker = true;
            } else {
              this.showDeparturePicker = true;
            }
          })

        Text('â–¼')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ left: 8 })
          .onClick(() => {
            if (required) {
              this.showCityPicker = true;
            } else {
              this.showDeparturePicker = true;
            }
          })
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  // è·å–åŸå¸‚å»ºè®®åˆ—è¡¨ï¼ˆç”¨äºæ¨¡ç³Šæœç´¢ï¼‰
  private getCitySuggestions(searchText: string, maxResults: number = 10): string[] {
    if (!searchText.trim()) {
      return [];
    }
    const searchLower = searchText.toLowerCase();
    const matches: string[] = [];
    for (const city of this.cities) {
      if (city.includes(searchText) || city.toLowerCase().includes(searchLower)) {
        matches.push(city);
        if (matches.length >= maxResults) {
          break;
        }
      }
    }
    return matches;
  }

  @Builder
  buildCityInputItem(icon: string, label: string, placeholder: string, value: string, required: boolean, type: string) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(16)
        Text(label)
          .fontSize(14)
          .fontColor('#333333')
          .margin({ left: 8 })
        if (required) {
          Text('*')
            .fontSize(14)
            .fontColor('#FF6B6B')
            .margin({ left: 2 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 8 })

      TextInput({ placeholder: placeholder, text: value })
        .width('100%')
        .height(44)
        .fontSize(14)
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
        .border({
          width: 1,
          color: '#E0E0E0',
        })
        .onChange((text: string) => {
          if (type === 'destination') {
            this.destination = text;
          } else {
            this.departure = text;
          }
        })
    }
    .width('100%')
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildCityPickerDialog(type: string) {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(type === 'destination' ? 'é€‰æ‹©ç›®çš„åœ°' : 'é€‰æ‹©å‡ºå‘åœ°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .fontSize(14)
          .backgroundColor('#F5F5F5')
          .fontColor('#333333')
          .onClick(() => {
            if (type === 'destination') {
              this.showCityPicker = false;
              this.citySearchText = '';
            } else {
              this.showDeparturePicker = false;
              this.departureSearchText = '';
            }
          })
      }
      .width('100%')
      .padding(16)
      .borderRadius({ topLeft: 12, topRight: 12 })
      .backgroundColor('#FFFFFF')

      // æœç´¢æ¡†
      Row() {
        TextInput({ 
          placeholder: 'æœç´¢åŸå¸‚', 
          text: type === 'destination' ? this.citySearchText : this.departureSearchText 
        })
          .layoutWeight(1)
          .height(40)
          .fontSize(14)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .onChange((text: string) => {
            if (type === 'destination') {
              this.citySearchText = text;
            } else {
              this.departureSearchText = text;
            }
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#FFFFFF')

      // åŸå¸‚åˆ—è¡¨ï¼ˆæŒ‰å­—æ¯åˆ†ç»„ï¼‰
      Scroll() {
        Column() {
          ForEach(
            Array.from((type === 'destination' ? this.getFilteredCities() : this.getFilteredDepartureCities()).entries())
              .sort((a, b) => a[0].localeCompare(b[0])), 
            (item: [string, string[]]) => {
              Column() {
                // å­—æ¯æ ‡é¢˜
                Row() {
                  Text(item[0])
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#007DFF')
                    .padding({ left: 16, top: 12, bottom: 8 })
                }
                .width('100%')
                .backgroundColor('#F8F8F8')

                // åŸå¸‚åˆ—è¡¨
                Column() {
                  ForEach(item[1], (city: string) => {
                    Row() {
                      Text(city)
                        .fontSize(15)
                        .fontColor('#333333')
                        .layoutWeight(1)
                      if ((type === 'destination' ? this.destination : this.departure) === city) {
                        Text('âœ“')
                          .fontSize(16)
                          .fontColor('#007DFF')
                          .margin({ right: 16 })
                      }
                    }
                    .width('100%')
                    .height(48)
                    .padding({ left: 32, right: 16 })
                    .backgroundColor((type === 'destination' ? this.destination : this.departure) === city ? '#F0F7FF' : '#FFFFFF')
                    .onClick(() => {
                      if (type === 'destination') {
                        this.destination = city;
                        this.showCityPicker = false;
                        this.citySearchText = '';
                      } else {
                        this.departure = city;
                        this.showDeparturePicker = false;
                        this.departureSearchText = '';
                      }
                    })
                  })
                }
                .width('100%')
              }
              .width('100%')
            }
          )
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .borderRadius(12)
    .backgroundColor('#FFFFFF')
  }

  @Builder
  buildCompanionPickerItem(icon: string, label: string, value: string) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(16)
        Text(label)
          .fontSize(14)
          .fontColor('#333333')
          .margin({ left: 8 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 8 })

      Row() {
        TextInput({ placeholder: 'é€‰æ‹©åŒè¡Œäººæ•°', text: value })
          .layoutWeight(1)
          .height(44)
          .fontSize(14)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .border({
            width: 1,
            color: '#E0E0E0',
          })
          .enabled(false)
          .onClick(() => {
            this.showCompanionPicker = true;
          })

        Text('â–¼')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ left: 8 })
          .onClick(() => {
            this.showCompanionPicker = true;
          })
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 16 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildCompanionPickerDialog() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©åŒè¡Œäººæ•°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .fontSize(14)
          .backgroundColor('#F5F5F5')
          .fontColor('#333333')
          .onClick(() => {
            this.showCompanionPicker = false;
          })
      }
      .width('100%')
      .padding(16)
      .borderRadius({ topLeft: 12, topRight: 12 })
      .backgroundColor('#FFFFFF')

      // é€‰é¡¹åˆ—è¡¨
      Column() {
        ForEach(this.companionOptions, (option: string) => {
          Row() {
            if (this.companions === option) {
              Text('âœ“')
                .fontSize(16)
                .fontColor('#007DFF')
                .margin({ right: 12 })
            } else {
              Text('')
                .fontSize(16)
                .width(20)
                .margin({ right: 12 })
            }
            Text(option)
              .fontSize(15)
              .fontColor('#333333')
              .layoutWeight(1)
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.companions === option ? '#F0F7FF' : '#FFFFFF')
          .onClick(() => {
            this.companions = option;
            this.showCompanionPicker = false;
          })
        })
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .borderRadius(12)
    .backgroundColor('#FFFFFF')
  }

  // æ¸…ç†markdownæ ¼å¼æ ‡è®°
  private cleanMarkdown(text: string): string {
    return text
      // ç§»é™¤æ ‡é¢˜æ ‡è®°
      .replace(/^#{1,6}\s+/gm, '')
      // ç§»é™¤ç²—ä½“æ ‡è®°ï¼Œä¿ç•™æ–‡æœ¬
      .replace(/\*\*(.*?)\*\*/g, '$1')
      // ç§»é™¤æ–œä½“æ ‡è®°
      .replace(/\*(.*?)\*/g, '$1')
      // ç§»é™¤ä»£ç å—æ ‡è®°
      .replace(/```[\s\S]*?```/g, '')
      // ç§»é™¤è¡Œå†…ä»£ç æ ‡è®°
      .replace(/`([^`]+)`/g, '$1')
      // å¤„ç†é“¾æ¥ï¼Œä¿ç•™æ–‡æœ¬
      .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
      // ç§»é™¤åˆ†éš”çº¿
      .replace(/^---+$/gm, '')
      // ç§»é™¤åˆ—è¡¨æ ‡è®°ï¼Œä¿ç•™æ–‡æœ¬
      .replace(/^[-*+]\s+/gm, '')
      .replace(/^\d+\.\s+/gm, '')
      // æ¸…ç†å¤šä½™ç©ºè¡Œ
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  }

  // å°†æ•°å­—è½¬æ¢ä¸ºä¸­æ–‡å¤§å†™æ•°å­—
  private numberToChinese(num: number): string {
    const chineseNumbers = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
    if (num <= 10) {
      return chineseNumbers[num];
    } else if (num < 20) {
      return 'å' + (num > 10 ? chineseNumbers[num % 10] : '');
    } else if (num < 100) {
      const tens = Math.floor(num / 10);
      const ones = num % 10;
      return chineseNumbers[tens] + 'å' + (ones > 0 ? chineseNumbers[ones] : '');
    }
    return String(num);
  }

  // å°†"ç¬¬Xå¤©"ä¸­çš„æ•°å­—è½¬æ¢ä¸ºä¸­æ–‡å¤§å†™
  private convertDayNumber(line: string): string {
    const match = line.match(/^ç¬¬(\d+)å¤©/);
    if (match) {
      const dayNum = parseInt(match[1], 10);
      const chineseDay = this.numberToChinese(dayNum);
      return line.replace(/^ç¬¬\d+å¤©/, `ç¬¬${chineseDay}å¤©`);
    }
    return line;
  }

  // æ£€æŸ¥æ˜¯å¦æ˜¯"ç¬¬Xå¤©"æ ‡é¢˜è¡Œ
  private isDayTitle(line: string): boolean {
    return /^ç¬¬\d+å¤©/.test(line.trim());
  }

  // è§£æå¹¶æ¸²æŸ“æ ¼å¼åŒ–æ–‡æœ¬
  @Builder
  buildFormattedText(text: string) {
    Column() {
      ForEach(this.cleanMarkdown(text).split('\n'), (line: string, index: number) => {
        if (line.trim() === '') {
          Blank()
            .height(8)
        } else {
          // æ£€æŸ¥æ˜¯å¦æ˜¯"ç¬¬Xå¤©"æ ‡é¢˜
          if (this.isDayTitle(line)) {
            Text(this.convertDayNumber(line))
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1F1F1F')
              .lineHeight(28)
              .margin({ top: 12, bottom: 8 })
              .alignSelf(ItemAlign.Start)
          } else {
            Text(line)
              .fontSize((line.length < 50 && !line.includes('ï¼š') && !line.includes(':')) ? 17 : 15)
              .fontWeight((line.length < 50 && !line.includes('ï¼š') && !line.includes(':')) ? FontWeight.Bold : FontWeight.Normal)
              .fontColor((line.length < 50 && !line.includes('ï¼š') && !line.includes(':')) ? '#1F1F1F' : '#333333')
              .lineHeight(24)
              .margin({ bottom: 6 })
              .alignSelf(ItemAlign.Start)
          }
        }
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // æ„å»ºPOIé¡¹å±•ç¤º
  @Builder
  buildPoiItem(item: PoiItem, index: number) {
    Column() {
      Row() {
        // POIå›¾ç‰‡
        if (item.image) {
          Image(item.image)
            .width(100)
            .height(100)
            .borderRadius(8)
            .objectFit(ImageFit.Cover)
            .alt('POIå›¾ç‰‡')
            .onError(() => {
              // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤„ç†
            })
        } else {
          // å ä½å›¾ç‰‡
          Column() {
            Text('ğŸ“')
              .fontSize(40)
              .fontColor('#CCCCCC')
          }
          .width(100)
          .height(100)
          .borderRadius(8)
          .backgroundColor('#F5F5F5')
          .justifyContent(FlexAlign.Center)
        }

        // POIä¿¡æ¯
        Column() {
          Text(item.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1F1F1F')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 6 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          if (item.address) {
            Text(item.address)
              .fontSize(13)
              .fontColor('#666666')
              .alignSelf(ItemAlign.Start)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ bottom: 4 })
          }

          Row() {
            if (item.score !== undefined) {
              Text(`â­ ${item.score.toFixed(1)}`)
                .fontSize(12)
                .fontColor('#FF9500')
            }
            if (item.distance !== undefined) {
              Text(`è·ç¦» ${item.distance}m`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ left: item.score !== undefined ? 12 : 0 })
            }
            if (item.tel) {
              Text(`ğŸ“ ${item.tel}`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ left: 12 })
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
          }
          .width('100%')
          .margin({ top: 4 })
          .alignItems(VerticalAlign.Center)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
        .height(100)
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: '#1F000000',
      offsetX: 0,
      offsetY: 2,
    })
  }
}

